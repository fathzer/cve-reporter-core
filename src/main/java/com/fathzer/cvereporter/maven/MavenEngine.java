package com.fathzer.cvereporter.maven;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileWriter;
import java.io.IOException;
import java.io.Reader;
import java.io.StringReader;
import java.nio.file.Files;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Optional;
import java.util.TreeMap;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import org.apache.maven.model.Model;
import org.apache.maven.model.io.xpp3.MavenXpp3Reader;
import org.codehaus.plexus.util.xml.pull.XmlPullParserException;

import com.fathzer.cvereporter.BuildEngine;
import com.fathzer.cvereporter.CodeRepository;
import com.fathzer.cvereporter.Dependencies;
import com.fathzer.cvereporter.Project;
import com.fathzer.cvereporter.Dependencies.ArtifactId;
import com.fathzer.cvereporter.Dependencies.Dependency;
import com.fathzer.cvereporter.Dependencies.Status;

import lombok.AllArgsConstructor;
import lombok.Getter;

@AllArgsConstructor
public class MavenEngine implements BuildEngine {
	private static final String POM_XML = "pom.xml";
	private static final String DEPENDENCY_FILE = "dependencies.txt";
	private static final String MAVEN_CMD;
	
	@AllArgsConstructor
	@Getter
	private static class PomConfig {
		Status status;
		Map<File,String> pathToPom;
	}
	
	private CodeRepository codeRepo;
	private File workingDir;
	
	static {
		MAVEN_CMD = System.getProperty("os.name").toLowerCase().startsWith("win") ? "mvn.cmd" : "mvn";
	}

	@Override
	public Dependencies getDependencies(Project project) throws IOException {
		final PomConfig config = getPoms(project);
		if (!Status.OK.equals(config.getStatus())) {
			return new Dependencies(config.getStatus(), null);
		}
		if (generate(config)!=0) {
			return new Dependencies(Status.BUILD_ERROR, null);
		}
		try (Stream<String> lines = Files.lines(new File(workingDir,DEPENDENCY_FILE).toPath())) {
			return new Dependencies(Status.OK, lines.map(this::toArtifact).filter(Optional::isPresent).map(Optional::get).collect(Collectors.toSet()));
		}
	}

	private PomConfig getPoms(Project project) throws IOException {
		try {
			final String pom = codeRepo.getFile(project, POM_XML);
			return getPoms(project, pom);
		} catch (FileNotFoundException e) {
			return new PomConfig(Status.NOT_THIS_BUILDER, null);
		}
	}
	
	private PomConfig getPoms(Project project, String pom) throws IOException {
		final Map<File,String> fileToPom = new TreeMap<>();
		try (Reader reader = new StringReader(pom)) {
			Model model = new MavenXpp3Reader().read(reader);
			List<String> modules = model.getModules();
			for (String module : modules) {
				final String path = module+"/"+POM_XML;
				fileToPom.put(new File(workingDir, path), codeRepo.getFile(project, path));
			}
		} catch (XmlPullParserException | IOException e) {
			return new PomConfig(Status.BUILD_ERROR,null);
		}
		fileToPom.put(new File(workingDir, POM_XML), pom);
		return new PomConfig(Status.OK, fileToPom);
	}
	
	private int generate(PomConfig config) throws IOException {
		for (Entry<File, String> pom : config.pathToPom.entrySet()) {
			pom.getKey().getParentFile().mkdirs();
			try (BufferedWriter writer= new BufferedWriter(new FileWriter(pom.getKey()))) {
				writer.write(pom.getValue());
			}
		}
		ProcessBuilder pb = new ProcessBuilder(Arrays.asList(MAVEN_CMD,"-q","-DoutputFile="+DEPENDENCY_FILE,"dependency:list"));
		pb.directory(workingDir);
		pb.redirectError(new File(workingDir,"errors.log"));
		pb.redirectOutput(new File(workingDir,"out.log"));
		Process p = pb.start();
		try {
			return p.waitFor();
		} catch (InterruptedException e) {
			Thread.currentThread().interrupt();
			return -1;
		}
	}
	
	private Optional<Dependency> toArtifact(String line) {
		if (!line.startsWith("   ") || "none".equals(line.trim())) {
			return Optional.empty();
		}
		String[] keys = line.split(":");
		return Optional.of(new Dependency(new ArtifactId(keys[0].trim(), keys[1].trim()), keys[3].trim()));
	}
}
