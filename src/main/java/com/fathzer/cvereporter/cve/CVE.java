package com.fathzer.cvereporter.cve;

import java.util.List;
import java.util.function.Predicate;
import java.util.stream.Collectors;

import org.apache.maven.artifact.versioning.InvalidVersionSpecificationException;
import org.apache.maven.artifact.versioning.VersionRange;

import com.fathzer.cvereporter.Dependencies.ArtifactId;
import com.fathzer.cvereporter.Dependencies.Dependency;

import lombok.Getter;

public class CVE implements Predicate<Dependency> {
	@Getter
	private final ArtifactId id;
	private final List<VersionRange> ranges;
	@Getter
	private final String description;

	public CVE(ArtifactId id, List<String> ranges, String description) {
		this.id = id;
		this.description = description;
		this.ranges = ranges.stream().map(this::toRange).collect(Collectors.toList());
	}

	private VersionRange toRange(String version) {
		try {
			return VersionRange.createFromVersionSpec(version);
		} catch (InvalidVersionSpecificationException e) {
			throw new IllegalArgumentException(e);
		}
	}

	@Override
	public boolean test(Dependency dependency) {
		return id.equals(dependency.getId()) && ranges.stream().anyMatch(r -> r.containsVersion(dependency.getVersion().getV()));
	}
}
