package com.fathzer.cvereporter;

import java.util.Collection;
import java.util.List;
import java.util.OptionalDouble;
import java.util.stream.Collectors;

import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.fathzer.cvereporter.common.Dependency;
import com.fathzer.cvereporter.cve.CVE;

import lombok.NonNull;

/** A security alert.
 */
public class Alert {
	private Dependency dependency;
	private List<CVE> causes;

	@JsonCreator(mode = JsonCreator.Mode.PROPERTIES)
	public Alert(@JsonProperty("dependency") @NonNull Dependency dependency, @JsonProperty("causes") @NonNull List<CVE> causes) {
		this.dependency = dependency;
		this.causes = causes;
	}

	@JsonIgnore
	public OptionalDouble getMaxScore() {
		return causes.stream().mapToDouble(CVE::getScore).filter(s->s>=0.0).max();
	}
	public static OptionalDouble getMaxScore(Collection<Alert> alerts) {
		return alerts.stream().map(Alert::getMaxScore).filter(OptionalDouble::isPresent).mapToDouble(OptionalDouble::getAsDouble).max();
	}

	@JsonIgnore
	public boolean hasUnknownScore() {
		return causes.stream().anyMatch(cve -> cve.getScore()<0.0);
	}
	public static boolean hasUnknownScore(Collection<Alert> alerts) {
		return alerts.stream().anyMatch(Alert::hasUnknownScore);
	}

	public Dependency getDependency() {
		return dependency;
	}

	public List<CVE> getCauses() {
		return causes;
	}

	@Override
	public String toString() {
		return dependency.toString()+": "+causes.stream().map(cve -> cve.getIdentifier()+" ("+cve.getScore()+")").collect(Collectors.toList()).toString();
	}
}
