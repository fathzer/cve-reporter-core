package com.fathzer.cvereporter.repository;

import static org.junit.jupiter.api.Assertions.*;

import java.io.IOException;
import java.io.Reader;
import java.io.StringReader;
import java.nio.file.NoSuchFileException;
import java.nio.file.Path;
import java.nio.file.Paths;

import org.apache.maven.model.Model;
import org.apache.maven.model.io.xpp3.MavenXpp3Reader;
import org.codehaus.plexus.util.xml.pull.XmlPullParserException;
import org.junit.jupiter.api.Test;

import com.fathzer.cvereporter.common.Project;

class LocalRepositoryTest {
	private static final String POM_XML = "pom.xml";
	
	private static final Path REPO_PATH = Paths.get("src/test/resources/projects");
	
	@Test
	void test() throws IOException, XmlPullParserException {
		final Path unkownDir = Paths.get("src/test/resources/unknownDir");
		assertThrows(IllegalArgumentException.class, () -> new LocalRepository(unkownDir));

		final LocalRepository repo = new LocalRepository(REPO_PATH);
		assertEquals(2, repo.getProjects().size());

		assertThrows(NoSuchFileException.class, () -> repo.getFile(new Project("0", "p2"), POM_XML));

		final String fileContent = repo.getFile(new Project("0", "p1"), POM_XML);
		try (Reader reader = new StringReader(fileContent)) {
			Model model = new MavenXpp3Reader().read(reader);
			assertEquals(0,model.getDependencies().size());
			assertEquals(2,model.getModules().size());
		}
	}
}
